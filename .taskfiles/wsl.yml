version: '3'

tasks:
  setup:
    desc: WSL2 system setup
    cmds:
      - task: check-wsl
      - task: packages
      - task: gui
      - task: summary

  check-wsl:
    desc: Verify running in WSL2
    silent: true
    cmds:
      - |
        if [ ! -f /proc/version ] || ! grep -qi microsoft /proc/version; then
          echo "Warning: This doesn't appear to be WSL2"
          exit 1
        fi
        echo "Detected WSL2 environment"

  packages:
    desc: Install essential packages via apt
    cmds:
      - sudo apt update > /dev/null 2>&1
      - |
        # Package list defined in configs/packages.yml
        echo "ğŸ“¦ Installing essential packages..."
        sudo apt install -y -qq \
          git \
          stow \
          zsh \
          neovim \
          tmux \
          fzf \
          ripgrep \
          fd-find \
          bat \
          zoxide \
          curl \
          wget \
          build-essential
      - |
        mkdir -p ~/.local/bin
        ln -sf $(which fdfind) ~/.local/bin/fd 2>/dev/null || true
        ln -sf $(which batcat) ~/.local/bin/bat 2>/dev/null || true
      - |
        # Install eza (modern ls replacement)
        if ! command -v eza &> /dev/null; then
          echo "ğŸ“¦ Installing eza..."
          sudo mkdir -p /etc/apt/keyrings 2>/dev/null
          wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc 2>/dev/null | sudo gpg --dearmor -o /etc/apt/keyrings/gierens.gpg 2>/dev/null
          echo "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | sudo tee /etc/apt/sources.list.d/gierens.list > /dev/null
          sudo chmod 644 /etc/apt/keyrings/gierens.gpg /etc/apt/sources.list.d/gierens.list 2>/dev/null
          sudo apt update > /dev/null 2>&1
          sudo apt install -y -qq eza
        fi

  gui:
    desc: Prepare Windows GUI apps info
    internal: true
    silent: true
    cmds:
      - echo "# GUI apps configured"

  summary:
    desc: Display setup summary
    silent: true
    cmds:
      - |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ“ WSL2 Setup Complete!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“‹ Next Steps:"
        echo ""
        echo "1. ğŸ³ Docker Desktop"
        echo "   Install Docker Desktop on Windows host and enable WSL2 integration"
        echo "   Download: https://www.docker.com/products/docker-desktop"
        echo ""
        echo "2. ğŸªŸ Windows GUI Applications"
        echo "   Run this command in PowerShell (on Windows host):"
        echo ""
        WINGET_JSON="configs/winget-packages.json"
        WINDOWS_PATH=$(wslpath -w "$(pwd)/$WINGET_JSON" 2>/dev/null || echo "")
        if [ -n "$WINDOWS_PATH" ]; then
          echo "   winget import -i '$WINDOWS_PATH' --accept-package-agreements --accept-source-agreements"
        else
          echo "   (Navigate to your device_configs folder and use winget-packages.json)"
        fi
        echo ""
        echo "   Includes: Windows Terminal, Chrome, Edge, Discord, Docker Desktop,"
        echo "   VS Code, Alacritty, Steam, GeForce Now, Moonlight"
        echo ""
        echo "3. ğŸ” SSH Key"
        echo "   Generate your SSH key: task ssh"
        echo ""
        echo "4. ğŸ“ Dotfiles"
        echo "   Setup dotfiles: task dotfiles"
        echo ""
        echo "5. ğŸš Shell"
        echo "   Log out and back in if you changed your default shell to zsh"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  update:
    desc: Update all apt packages
    cmds:
      - sudo apt update
      - sudo apt upgrade -y
      - sudo apt autoremove -y

  clean:
    desc: Clean apt cache
    cmds:
      - sudo apt clean
      - sudo apt autoremove -y
