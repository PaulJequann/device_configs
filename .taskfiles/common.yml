version: "3"

vars:
  DOTFILES_REPO: "git@github.com:PaulJequann/.dotfiles.git"
  DOTFILES_DIR: "{{.HOME}}/.dotfiles"

tasks:
  setup:
    desc: Common setup tasks for all platforms
    cmds:
      - task: terminal
      - task: dotfiles
      - task: packages
      - echo "âœ“ Common setup complete!"

  packages:
    desc: Install all packages (Homebrew or platform-native)
    silent: true
    cmds:
      - |
        # Read package lists from packages.yml using yq
        COMMON_BREW_CLI_TOOLS=($(yq -r '.cli_tools | join(" ")' configs/packages.yml))
        ARCH_BREW_CLI_TOOLS=($(yq -r '.arch_brew_cli_tools | join(" ")' configs/packages.yml))

        install_brew_package() {
          local pkg="$1"
          if brew list "$pkg" &>/dev/null 2>&1; then
            brew upgrade "$pkg" 2>/dev/null || true
          else
            brew install "$pkg"
          fi
        }

        install_brew_packages() {
          local pkg
          for pkg in "$@"; do
            install_brew_package "$pkg"
          done
        }

        install_bun() {
          echo "ðŸ“¦ Installing bun via oven-sh/bun tap..."
          brew tap oven-sh/bun 2>/dev/null || true
          if brew list oven-sh/bun/bun &>/dev/null; then
            brew upgrade oven-sh/bun/bun 2>/dev/null || true
          else
            brew install oven-sh/bun/bun
          fi
        }

        install_uv() {
          echo "ðŸ“¦ Installing uv..."
          if brew list uv &>/dev/null; then
            brew upgrade uv 2>/dev/null || true
          else
            brew install uv
          fi
        }

        install_beads_viewer() {
          echo "ðŸ“¦ Installing beads_viewer via steveyegge/beads tap..."
          brew tap steveyegge/beads 2>/dev/null || true
          if brew list beads_viewer &>/dev/null 2>&1; then
            brew upgrade beads_viewer 2>/dev/null || true
          else
            brew install beads_viewer
          fi
        }

        install_beads_tools() {
          echo "ðŸ“¦ Installing beads tools via steveyegge/beads tap..."
          brew tap steveyegge/beads 2>/dev/null || true
          if brew list bd &>/dev/null 2>&1; then
            brew upgrade bd 2>/dev/null || true
          else
            brew install steveyegge/beads/bd
          fi
          install_beads_viewer
        }

        install_arch_brew_cli_tools() {
          if [ ${#ARCH_BREW_CLI_TOOLS[@]} -eq 0 ]; then
            return
          fi
          echo "ðŸ“¦ Installing Arch-only Homebrew tools..."
          local pkg
          for pkg in "${ARCH_BREW_CLI_TOOLS[@]}"; do
            if [ "$pkg" = "beads_viewer" ]; then
              install_beads_viewer
            else
              install_brew_package "$pkg"
            fi
          done
        }

        if [ -f /etc/arch-release ]; then
          echo "ðŸ“¦ Arch CLI tools handled via pacman/yay (see arch:packages)."
          install_arch_brew_cli_tools
          echo "ðŸ“¦ Skipping bun/uv/opencode Homebrew installs on Arch."
        else
          echo "ðŸ“¦ Installing core CLI tools via Homebrew..."
          install_brew_packages "${COMMON_BREW_CLI_TOOLS[@]}"
          install_bun
          install_uv
          install_beads_tools
          echo "ðŸ“¦ Installing opencode..."
          if command -v opencode &>/dev/null; then
            echo "  âœ“ opencode already installed"
          else
            echo "  Installing opencode via Homebrew..."
            install_brew_package opencode
          fi
        fi

        echo "âœ“ All packages installed/updated!"

  gui:
    desc: Install GUI applications
    cmds:
      - |
        {{if eq OS "darwin"}}
        echo "ðŸ“¦ Installing macOS GUI apps via Homebrew Cask..."
        CASKS=$(yq -r '.gui_macos | join(" ")' configs/packages.yml)
        brew install --cask $CASKS 2>/dev/null || true
        {{else}}
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ðŸ“‹ Windows GUI Applications"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "Run this command in PowerShell on Windows host:"
        echo ""
        WINGET_JSON="configs/winget-packages.json"
        WINDOWS_PATH=$(wslpath -w "$(pwd)/$WINGET_JSON" 2>/dev/null || echo "")
        if [ -n "$WINDOWS_PATH" ]; then
          echo "   winget import -i '$WINDOWS_PATH' --accept-package-agreements --accept-source-agreements"
        else
          echo "   Navigate to device_configs folder and run: winget import -i configs/winget-packages.json"
        fi
        echo ""
        echo "Includes: Windows Terminal, VS Code, Chrome, Edge, Discord, Docker Desktop,"
        echo "Claude Code, Antigravity, Cursor, Zed, Ollama, Bruno, Alacritty, Steam,"
        echo "GeForce Now, Moonlight"
        echo ""
        {{end}}

  sync:
    desc: Sync device_configs and dotfiles, install new packages
    cmds:
      - |
        echo "ðŸ”„ Syncing device_configs..."
        git -C "{{.ROOT_DIR}}" pull --rebase origin main 2>/dev/null || echo "âš ï¸  Failed to sync device_configs (check git status)"
      - |
        if [ -d "{{.DOTFILES_DIR}}" ]; then
          echo "ðŸ”„ Syncing dotfiles..."
          git -C "{{.DOTFILES_DIR}}" pull --rebase origin main 2>/dev/null || echo "âš ï¸  Failed to sync dotfiles (check git status)"
          echo "ðŸ”— Re-running dotfiles bootstrap..."
          bash "{{.DOTFILES_DIR}}/bootstrap.sh" 2>/dev/null || echo "âš ï¸  Bootstrap failed"
        else
          echo "ðŸ“ Dotfiles not found, run 'task dotfiles' first"
        fi
      - |
        echo ""
        echo "âœ“ Sync complete! Installing any new packages..."
        task common:packages

  terminal:
    desc: Setup terminal environment (zsh, oh-my-zsh, zgenom)
    cmds:
      - |
        # Install oh-my-zsh if not present
        if [ ! -d "$HOME/.oh-my-zsh" ]; then
          echo "ðŸ”§ Installing oh-my-zsh..."
          sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended > /dev/null 2>&1
        fi
      - |
        # Install zgenom if not present
        if [ ! -d "$HOME/.zgenom" ]; then
          echo "ðŸ”§ Installing zgenom..."
          git clone https://github.com/jandamm/zgenom.git "${HOME}/.zgenom" > /dev/null 2>&1
        fi
      - |
        # Prompt to set zsh as default shell
        CURRENT_SHELL=$(basename "$SHELL")
        if [ "$CURRENT_SHELL" != "zsh" ]; then
          echo ""
          printf "ðŸš Would you like to set zsh as your default shell? (y/n) "
          read REPLY
          if [ "$REPLY" = "y" ] || [ "$REPLY" = "Y" ]; then
            ZSH_PATH=$(command -v zsh)
            if ! grep -q "$ZSH_PATH" /etc/shells 2>/dev/null; then
              echo "$ZSH_PATH" | sudo tee -a /etc/shells > /dev/null
            fi
            chsh -s "$ZSH_PATH" > /dev/null 2>&1
            echo "âœ“ Default shell changed to zsh (log out and back in to activate)"
          fi
        fi

  dotfiles:
    desc: Clone and setup dotfiles
    cmds:
      - |
        if [ ! -d "{{.DOTFILES_DIR}}" ]; then
          echo "ðŸ“ Cloning dotfiles repository..."
          git clone {{.DOTFILES_REPO}} {{.DOTFILES_DIR}} > /dev/null 2>&1
        else
          cd {{.DOTFILES_DIR}} && git pull > /dev/null 2>&1
        fi
      - |
        if [ -f "{{.DOTFILES_DIR}}/bootstrap.sh" ]; then
          echo "ðŸ”— Bootstrapping dotfiles..."
          bash "{{.DOTFILES_DIR}}/bootstrap.sh"
        else
          # Fallback for backwards compatibility (old dotfiles structure)
          if command -v stow &> /dev/null; then
            echo "ðŸ”— Stowing dotfiles (legacy mode)..."
            cd {{.DOTFILES_DIR}} && stow . 2>/dev/null
          fi
        fi

  ssh:
    desc: Generate SSH key for this device
    cmds:
      - |
        DEVICE_NAME=$(hostname)
        SSH_KEY="$HOME/.ssh/id_ed25519"

        if [ -f "$SSH_KEY" ]; then
          echo "SSH key already exists at $SSH_KEY"
          echo "Public key:"
          cat "$SSH_KEY.pub"
        else
          echo "Generating new SSH key for device: $DEVICE_NAME"
          ssh-keygen -t ed25519 -C "$DEVICE_NAME" -f "$SSH_KEY" -N ""
          echo ""
          echo "SSH key generated! Public key:"
          cat "$SSH_KEY.pub"
          echo ""
          echo "Add this key to your GitHub/GitLab account:"
          echo "  GitHub: https://github.com/settings/keys"
          echo "  GitLab: https://gitlab.com/-/profile/keys"
        fi

  check:
    desc: Check system configuration
    silent: true
    cmds:
      - |
        echo "=== System Check ==="
        echo "OS: {{OS}}/{{ARCH}}"
        echo ""
        echo "=== Homebrew ==="
        if command -v brew &> /dev/null; then
          echo "âœ“ Homebrew installed ($(brew --version | head -1))"
        else
          echo "âœ— Homebrew not installed"
        fi
        echo ""
        echo "=== CLI Tools ==="
        for cmd in git stow zsh neovim tmux fzf rg fd bat eza zoxide bun task gemini; do
          if command -v $cmd &> /dev/null; then
            echo "âœ“ $cmd"
          else
            echo "âœ— $cmd (not found)"
          fi
        done
        echo ""
        echo "=== AI Coding Tools ==="
        for cmd in claude opencode bd; do
          if command -v $cmd &> /dev/null; then
            echo "âœ“ $cmd"
          else
            echo "â—‹ $cmd (not installed)"
          fi
        done
        echo ""
        echo "=== SSH Key ==="
        if [ -f "$HOME/.ssh/id_ed25519.pub" ]; then
          echo "âœ“ SSH key exists"
          cat "$HOME/.ssh/id_ed25519.pub"
        else
          echo "âœ— No SSH key found (run 'task ssh' to generate)"
        fi
