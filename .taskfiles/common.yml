version: '3'

vars:
  DOTFILES_REPO: "git@github.com:PaulJequann/dotfiles.git"
  DOTFILES_DIR: "{{.HOME}}/.dotfiles"

tasks:
  setup:
    desc: Common setup tasks for all platforms
    cmds:
      - task: terminal
      - task: dotfiles
      - task: packages
      - echo "Common setup complete!"

  packages:
    desc: Install common CLI packages
    cmds:
      - |
        if ! command -v claude &> /dev/null; then
          echo "ðŸ”§ Installing claude..."
          curl -fsSL https://raw.githubusercontent.com/anthropics/claude-code/main/install.sh | bash > /dev/null 2>&1
        fi
      - |
        if ! command -v bd &> /dev/null; then
          echo "ðŸ”§ Installing beads..."
          curl -fsSL https://raw.githubusercontent.com/steveyegge/beads/main/scripts/install.sh | bash > /dev/null 2>&1
        fi
      - |
        if ! command -v opencode &> /dev/null; then
          echo "ðŸ”§ Installing opencode..."
          curl -fsSL https://opencode.ai/install | bash > /dev/null 2>&1
        fi
      - |
        if ! command -v pnpm &> /dev/null; then
          echo "ðŸ”§ Installing pnpm..."
          curl -fsSL https://get.pnpm.io/install.sh | sh - > /dev/null 2>&1
        fi

  sync:
    desc: Sync device_configs and dotfiles from remote repositories
    cmds:
      - |
        echo "ðŸ”„ Syncing device_configs..."
        git -C "{{.ROOT_DIR}}" pull --rebase origin main 2>/dev/null || echo "âš ï¸  Failed to sync device_configs (check git status)"
      - |
        if [ -d "{{.DOTFILES_DIR}}" ]; then
          echo "ðŸ”„ Syncing dotfiles..."
          git -C "{{.DOTFILES_DIR}}" pull --rebase origin main 2>/dev/null || echo "âš ï¸  Failed to sync dotfiles (check git status)"
          echo "ðŸ”— Re-running dotfiles bootstrap..."
          bash "{{.DOTFILES_DIR}}/bootstrap.sh" 2>/dev/null || echo "âš ï¸  Bootstrap failed"
        else
          echo "ðŸ“ Dotfiles not found, run 'task dotfiles' first"
        fi
      - |
        echo ""
        echo "âœ“ Sync complete! Installing any new packages..."
        task common:packages

  terminal:
    desc: Setup terminal environment (zsh, oh-my-zsh, zgenom)
    cmds:
      - |
        # Install oh-my-zsh if not present
        if [ ! -d "$HOME/.oh-my-zsh" ]; then
          echo "ðŸ”§ Installing oh-my-zsh..."
          sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended > /dev/null 2>&1
        fi
      - |
        # Install zgenom if not present
        if [ ! -d "$HOME/.zgenom" ]; then
          echo "ðŸ”§ Installing zgenom..."
          git clone https://github.com/jandamm/zgenom.git "${HOME}/.zgenom" > /dev/null 2>&1
        fi
      - |
        # Prompt to set zsh as default shell
        CURRENT_SHELL=$(basename "$SHELL")
        if [ "$CURRENT_SHELL" != "zsh" ]; then
          echo ""
          printf "ðŸš Would you like to set zsh as your default shell? (y/n) "
          read REPLY
          if [ "$REPLY" = "y" ] || [ "$REPLY" = "Y" ]; then
            ZSH_PATH=$(command -v zsh)
            if ! grep -q "$ZSH_PATH" /etc/shells 2>/dev/null; then
              echo "$ZSH_PATH" | sudo tee -a /etc/shells > /dev/null
            fi
            chsh -s "$ZSH_PATH" > /dev/null 2>&1
            echo "âœ“ Default shell changed to zsh (log out and back in to activate)"
          fi
        fi

  dotfiles:
    desc: Clone and setup dotfiles
    cmds:
      - |
        if [ ! -d "{{.DOTFILES_DIR}}" ]; then
          echo "ðŸ“ Cloning dotfiles repository..."
          git clone {{.DOTFILES_REPO}} {{.DOTFILES_DIR}} > /dev/null 2>&1
        else
          cd {{.DOTFILES_DIR}} && git pull > /dev/null 2>&1
        fi
      - |
        if [ -f "{{.DOTFILES_DIR}}/bootstrap.sh" ]; then
          echo "ðŸ”— Bootstrapping dotfiles..."
          bash "{{.DOTFILES_DIR}}/bootstrap.sh"
        else
          # Fallback for backwards compatibility (old dotfiles structure)
          if command -v stow &> /dev/null; then
            echo "ðŸ”— Stowing dotfiles (legacy mode)..."
            cd {{.DOTFILES_DIR}} && stow . 2>/dev/null
          fi
        fi

  ssh:
    desc: Generate SSH key for this device
    cmds:
      - |
        DEVICE_NAME=$(hostname)
        SSH_KEY="$HOME/.ssh/id_ed25519"

        if [ -f "$SSH_KEY" ]; then
          echo "SSH key already exists at $SSH_KEY"
          echo "Public key:"
          cat "$SSH_KEY.pub"
        else
          echo "Generating new SSH key for device: $DEVICE_NAME"
          ssh-keygen -t ed25519 -C "$DEVICE_NAME" -f "$SSH_KEY" -N ""
          echo ""
          echo "SSH key generated! Public key:"
          cat "$SSH_KEY.pub"
          echo ""
          echo "Add this key to your GitHub/GitLab account:"
          echo "  GitHub: https://github.com/settings/keys"
          echo "  GitLab: https://gitlab.com/-/profile/keys"
        fi

  check:
    desc: Check system configuration
    silent: true
    cmds:
      - |
        echo "=== System Check ==="
        echo "OS: {{OS}}/{{ARCH}}"
        echo ""
        echo "=== Required Tools ==="
        for cmd in git stow neovim tmux fzf; do
          if command -v $cmd &> /dev/null; then
            echo "âœ“ $cmd ($(command -v $cmd))"
          else
            echo "âœ— $cmd (not found)"
          fi
        done
        echo ""
        echo "=== Optional Tools ==="
        for cmd in docker claude opencode; do
          if command -v $cmd &> /dev/null; then
            echo "âœ“ $cmd ($(command -v $cmd))"
          else
            echo "â—‹ $cmd (not installed)"
          fi
        done
        echo ""
        echo "=== SSH Key ==="
        if [ -f "$HOME/.ssh/id_ed25519.pub" ]; then
          echo "âœ“ SSH key exists"
          cat "$HOME/.ssh/id_ed25519.pub"
        else
          echo "âœ— No SSH key found (run 'task ssh' to generate)"
        fi
