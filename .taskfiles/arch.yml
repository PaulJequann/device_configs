version: "3"

vars:
  PKG_CONFIG: "configs/packages.yml"

tasks:
  setup:
    desc: Arch Linux system setup
    cmds:
      - task: yay
      - task: packages
      - task: z13
      - task: hyprland
      - task: gui
      - task: docker
      - echo "âœ“ Arch Linux setup complete!"

  install-yq:
    internal: true
    cmds:
      - |
        if ! command -v yq &> /dev/null; then
          echo "ðŸ“¦ Installing yq..."
          sudo pacman -S --needed --noconfirm yq
        fi

  packages:
    desc: Install core CLI tools via pacman and yay
    deps: [install-yq]
    cmds:
      - echo "ðŸ“¦ Installing Arch CLI tools..."
      - sudo pacman -S --needed --noconfirm $(yq -r '.arch_pacman_cli_tools | join(" ")' {{.PKG_CONFIG}})
      - |
        if command -v yay &> /dev/null; then
          yay -S --needed --noconfirm $(yq -r '.arch_aur_cli_tools | join(" ")' {{.PKG_CONFIG}})
        else
          echo "âš ï¸ yay not found, skipping AUR tools."
        fi

  yay:
    desc: Install yay (AUR helper)
    status:
      - command -v yay
    cmds:
      - echo "Installing yay..."
      - git clone https://aur.archlinux.org/yay.git /tmp/yay
      - cd /tmp/yay && makepkg -si --noconfirm
      - rm -rf /tmp/yay
      - echo "âœ“ yay installed"

  hyprland:
    desc: Install Hyprland and SDDM configuration
    deps: [install-yq]
    cmds:
      - |
        # Prompt the user for confirmation
        read -p "ðŸªŸ Are you using Hyprland? (y/N): " REPLY
        if [[ "$REPLY" =~ ^[Yy]$ ]]; then
          echo "ðŸ“¦ Installing Hyprland dependencies via pacman..."
          sudo pacman -S --needed --noconfirm $(yq -r '.arch_pacman_hyprland_dependencies | join(" ")' {{.PKG_CONFIG}})

          # Check for AUR dependencies
          if command -v yay &> /dev/null; then
            echo "ðŸ“¦ Installing Hyprland AUR dependencies..."
            yay -S --needed --noconfirm $(yq -r '.arch_aur_hyprland_dependencies | join(" ")' {{.PKG_CONFIG}})
          fi

          # 1. Ensure the random wallpaper script is executable.
          echo "ðŸ“‚ Setting permissions for wallpaper script..."
          chmod +x /home/pj/.dotfiles/arch-hyprland/.config/hypr/scripts/hyprlock-wallpaper.sh
          chmod +x /home/pj/.dotfiles/arch-hyprland/.config/hypr/scripts/update-primary-monitor.sh
          chmod +x /home/pj/.dotfiles/arch-hyprland/.config/hypr/scripts/lid-event.sh
          chmod +x /home/pj/.dotfiles/arch-hyprland/.config/hypr/scripts/hypr-monitor-watch.sh
          # 2. Create directory and symlink systemd units
          echo "ðŸ”— Linking systemd wallpaper units..."
          mkdir -p ~/.config/systemd/user/
          ln -sf /home/pj/.dotfiles/arch-hyprland/.config/systemd/user/hyprlock-wallpaper.service ~/.config/systemd/user/hyprlock-wallpaper.service
          ln -sf /home/pj/.dotfiles/arch-hyprland/.config/systemd/user/hyprlock-wallpaper.timer ~/.config/systemd/user/hyprlock-wallpaper.timer
          ln -sf /home/pj/.dotfiles/arch-hyprland/.config/systemd/user/hypr-monitor-watch.service ~/.config/systemd/user/hypr-monitor-watch.service

          # Enable wallpaper timer if the unit exists
          if [ -f "$HOME/.config/systemd/user/wallpaper-cycle.timer" ]; then
            echo "ðŸ–¼ï¸  Enabling wallpaper-cycle.timer..."
            systemctl --user daemon-reload
            systemctl --user enable --now wallpaper-cycle.timer
            systemctl --user enable --now hyprlock-wallpaper.timer
            systemctl --user enable hypr-monitor-watch.service
          fi

          # Main SDDM Config
          echo "ðŸ–¥ï¸  Configuring /etc/sddm.conf for virtual keyboard and silent theme..."
          sudo tee /etc/sddm.conf > /dev/null <<EOF
        [Autologin]
        Session=hyprland

        [General]
        InputMethod=qtvirtualkeyboard
        GreeterEnvironment=QML2_IMPORT_PATH=/usr/share/sddm/themes/silent/components/,QT_IM_MODULE=qtvirtualkeyboard

        [Theme]
        Current=silent
        EOF

          echo "âœ“ Hyprland dependencies and SDDM setup complete"
        else
          echo "â­ï¸  Skipping Hyprland setup"
        fi

  z13:
    desc: Install Asus ROG Flow Z13 specific tools and monitor configs
    deps: [install-yq]
    cmds:
      - |
        PRODUCT=$(cat /sys/class/dmi/id/product_name 2>/dev/null)
        if [[ "$PRODUCT" == *"Flow Z13"* || "$PRODUCT" == *"GZ301"* ]]; then
          echo "ðŸŽ® ROG Flow Z13 Detected"
          sudo pacman -S --needed --noconfirm $(yq -r '.arch_z13_pacman_cli_tools | join(" ")' {{.PKG_CONFIG}})

          # Thunderbolt Rescan Script
          sudo tee /usr/local/bin/thunderbolt-rescan.sh > /dev/null <<'EOF'
        #!/bin/bash
        echo 1 > /sys/bus/pci/rescan
        EOF
          sudo chmod +x /usr/local/bin/thunderbolt-rescan.sh
          echo 'ACTION=="change", SUBSYSTEM=="thunderbolt", ATTR{authorized}=="1", RUN+="/usr/local/bin/thunderbolt-rescan.sh"' | sudo tee /etc/udev/rules.d/98-thunderbolt-rescan.rules
          sudo udevadm control --reload-rules

          # SDDM X11 Monitor Setup
          sudo mkdir -p /usr/share/sddm/scripts
          sudo tee /usr/share/sddm/scripts/Xsetup_monitors > /dev/null <<'EOF'
        #!/bin/sh
        if xrandr | grep -q "HDMI-A-1 connected"; then
            xrandr --output HDMI-A-1 --primary --mode 3840x2160 --pos 0x0 --rotate normal --output eDP-1 --off
        else
            xrandr --output eDP-1 --primary --mode 2560x1600 --pos 0x0 --rotate normal
        fi
        EOF
          sudo chmod +x /usr/share/sddm/scripts/Xsetup_monitors

          sudo mkdir -p /etc/sddm.conf.d
          sudo tee /etc/sddm.conf.d/10-monitor.conf > /dev/null <<'EOF'
        [X11]
        DisplayCommand=/usr/share/sddm/scripts/Xsetup_monitors
        EOF
          echo "âœ“ Z13 optimizations and monitor configs applied"
        fi

  docker:
    desc: Configure Docker service
    cmds:
      - |
        if command -v docker &> /dev/null; then
          sudo systemctl enable --now docker
          sudo usermod -aG docker $USER
          echo "âœ“ Docker service configured"
        fi

  gui:
    desc: Install GUI applications
    deps: [install-yq]
    cmds:
      - sudo pacman -S --needed --noconfirm $(yq -r '.gui_arch_pacman | join(" ")' {{.PKG_CONFIG}})
      - |
        if command -v yay &> /dev/null; then
          yay -S --needed --noconfirm $(yq -r '.gui_arch_aur | join(" ")' {{.PKG_CONFIG}})
        fi

  update:
    desc: Update all packages
    cmds:
      - sudo pacman -Syu --noconfirm
      - "if command -v yay &> /dev/null; then yay -Syu --noconfirm; fi"

  clean:
    desc: Clean package caches
    cmds:
      - sudo pacman -Sc --noconfirm
      - "if command -v yay &> /dev/null; then yay -Sc --noconfirm; fi"
