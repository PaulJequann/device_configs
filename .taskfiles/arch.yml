version: "3"

tasks:
  setup:
    desc: Arch Linux system setup
    cmds:
      - task: yay
      - task: packages
      - task: z13
      - task: hyprland
      - task: gui
      - task: docker
      - echo "âœ“ Arch Linux setup complete!"

  packages:
    desc: Install core CLI tools via pacman and yay
    cmds:
      - |
        # Bootstrap: ensure yq is installed for YAML parsing
        if ! command -v yq &> /dev/null; then
          echo "ðŸ“¦ Installing yq (required for reading packages.yml)..."
          sudo pacman -S --needed --noconfirm yq
        fi
      - |
        echo "ðŸ“¦ Installing Arch CLI tools via pacman..."
        PACKAGES=$(yq -r '.arch_pacman_cli_tools | join(" ")' configs/packages.yml)
        sudo pacman -S --needed --noconfirm $PACKAGES
      - |
        echo "ðŸ“¦ Installing Arch AUR tools via yay..."
        if command -v yay &> /dev/null; then
          PACKAGES=$(yq -r '.arch_aur_cli_tools | join(" ")' configs/packages.yml)
          yay -S --needed --noconfirm $PACKAGES
        else
          echo "âš ï¸ yay not installed, skipping AUR tools. Run 'task arch:yay' first."
        fi

  docker:
    desc: Configure Docker service
    cmds:
      - |
        echo "ðŸ³ Configuring Docker service..."
        if command -v docker &> /dev/null; then
          sudo systemctl enable docker 2>/dev/null || true
          sudo systemctl start docker 2>/dev/null || true
          sudo usermod -aG docker $USER 2>/dev/null || true
          echo "âœ“ Docker service configured"
          echo "Note: Log out and back in for Docker group membership to take effect"
        else
          echo "Docker not installed yet. Install via Homebrew: brew install docker"
        fi

  yay:
    desc: Install yay (AUR helper)
    cmds:
      - |
        if ! command -v yay &> /dev/null; then
          echo "Installing yay (AUR helper)..."
          cd /tmp
          git clone https://aur.archlinux.org/yay.git 2>/dev/null || true
          cd yay
          makepkg -si --noconfirm
          cd ~
          echo "âœ“ yay installed"
        else
          echo "âœ“ yay already installed"
        fi

  gui:
    desc: Install GUI applications via pacman and AUR
    cmds:
      - |
        echo "ðŸ“¦ Installing GUI applications via pacman..."
        PACKAGES=$(yq -r '.gui_arch_pacman | join(" ")' configs/packages.yml)
        sudo pacman -S --needed --noconfirm $PACKAGES 2>/dev/null || true
      - |
        echo "ðŸ“¦ Installing GUI applications via AUR..."
        if command -v yay &> /dev/null; then
          PACKAGES=$(yq -r '.gui_arch_aur | join(" ")' configs/packages.yml)
          yay -S --needed --noconfirm $PACKAGES 2>/dev/null || true
        else
          echo "yay not installed. Run 'task arch:yay' first"
        fi

  hyprland:
    desc: Install Hyprland window manager dependencies
    cmds:
      - |
        printf "ðŸªŸ Are you using Hyprland? (y/n) "
        read -r REPLY
        if [ "$REPLY" = "y" ] || [ "$REPLY" = "Y" ]; then
          echo "ðŸ“¦ Installing Hyprland dependencies via pacman..."
          PACKAGES=$(yq -r '.arch_pacman_hyprland_dependencies | join(" ")' configs/packages.yml)
          sudo pacman -S --needed --noconfirm $PACKAGES

          if command -v yay &> /dev/null; then
            echo "ðŸ“¦ Installing Hyprland AUR dependencies..."
            PACKAGES=$(yq -r '.arch_aur_hyprland_dependencies | join(" ")' configs/packages.yml)
            yay -S --needed --noconfirm $PACKAGES
          fi
          if systemctl --user --version &> /dev/null; then
            if [ -f "$HOME/.config/systemd/user/wallpaper-cycle.timer" ]; then
              echo "ðŸ–¼ï¸ Enabling wallpaper-cycle.timer..."
              systemctl --user daemon-reload
              systemctl --user enable --now wallpaper-cycle.timer
            else
              echo "âš ï¸ wallpaper-cycle.timer not found. Re-run stow to pick up systemd user units."
            fi
          else
            echo "âš ï¸ systemctl --user not available, skipping wallpaper-cycle.timer enablement."
          fi
          echo "âœ“ Hyprland dependencies installed"
        else
          echo "â­ï¸ Skipping Hyprland dependencies"
        fi

  z13:
    desc: Install Asus ROG Flow Z13 specific tools
    cmds:
      - |
        PRODUCT_NAME=$(cat /sys/class/dmi/id/product_name 2>/dev/null || echo "")
        if [[ "$PRODUCT_NAME" == *"Flow Z13"* ]] || [[ "$PRODUCT_NAME" == *"GZ301"* ]]; then
          echo "ðŸŽ® Detected Asus ROG Flow Z13"

          # Install Z13-specific packages
          echo "ðŸ“¦ Installing Z13-specific tools..."
          PACKAGES=$(yq -r '.arch_z13_pacman_cli_tools | join(" ")' configs/packages.yml)
          sudo pacman -S --needed --noconfirm $PACKAGES

          # Setup Thunderbolt PCI rescan
          echo "âš¡ Setting up Thunderbolt PCI rescan..."
          sudo tee /usr/local/bin/thunderbolt-rescan.sh > /dev/null << 'SCRIPT'
        #!/bin/bash
        echo 1 > /sys/bus/pci/rescan
        SCRIPT
          sudo chmod +x /usr/local/bin/thunderbolt-rescan.sh

          sudo tee /etc/udev/rules.d/98-thunderbolt-rescan.rules > /dev/null << 'RULE'
        ACTION=="change", SUBSYSTEM=="thunderbolt", ATTR{authorized}=="1", RUN+="/usr/local/bin/thunderbolt-rescan.sh"
        RULE
          sudo udevadm control --reload-rules
          echo "âœ“ Thunderbolt PCI rescan configured"

          # Setup SDDM monitor configuration
          echo "ðŸ–¥ï¸ Setting up SDDM monitor configuration..."

          # Create Xsetup_monitors script
          sudo mkdir -p /usr/share/sddm/scripts
          sudo tee /usr/share/sddm/scripts/Xsetup_monitors > /dev/null << 'SCRIPT'
#!/bin/sh
# Check if external monitor (e.g., DP-2) is connected
if xrandr | grep -q "HDMI-A-1 connected"; then
    xrandr --output HDMI-A-1 --primary --mode 3840x2160 --pos 0x0 --rotate normal --output eDP-1 --off
else
    xrandr --output eDP-1 --primary --mode 2560x1600 --pos 0x0 --rotate normal
fi
SCRIPT
          sudo chmod +x /usr/share/sddm/scripts/Xsetup_monitors

          # Create SDDM config
          sudo mkdir -p /etc/sddm.conf.d
          sudo tee /etc/sddm.conf.d/10-monitor.conf > /dev/null << 'CONF'
[X11]
DisplayCommand=/usr/share/sddm/scripts/Xsetup_monitors
CONF
          echo "âœ“ SDDM monitor configuration configured"

          echo "âœ“ Z13 setup complete"
        else
          echo "â­ï¸ Not a Z13 device, skipping (detected: $PRODUCT_NAME)"
        fi

  update:
    desc: Update all packages (pacman + AUR + optional Homebrew)
    cmds:
      - |
        echo "Updating Arch packages (pacman)..."
        sudo pacman -Syu --noconfirm
      - |
        if command -v yay &> /dev/null; then
          echo "Updating AUR packages..."
          yay -Syu --noconfirm
        fi
      - |
        if command -v brew &> /dev/null; then
          echo "Updating Homebrew packages..."
          brew update && brew upgrade && brew cleanup
        fi

  clean:
    desc: Clean package caches
    cmds:
      - |
        echo "Cleaning pacman cache..."
        sudo pacman -Sc --noconfirm
      - |
        if command -v yay &> /dev/null; then
          echo "Cleaning AUR cache..."
          yay -Sc --noconfirm
        fi
      - |
        if command -v brew &> /dev/null; then
          echo "Cleaning Homebrew cache..."
          brew cleanup -s
          rm -rf $(brew --cache)
        fi
