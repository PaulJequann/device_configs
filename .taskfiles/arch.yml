version: "3"

tasks:
  setup:
    desc: Arch Linux system setup
    cmds:
      - task: yay
      - task: packages
      - task: z13
      - task: hyprland
      - task: gui
      - task: docker
      - echo "âœ“ Arch Linux setup complete!"

  packages:
    desc: Install core CLI tools via pacman and yay
    cmds:
      - |
        # Bootstrap: ensure yq is installed for YAML parsing
        if ! command -v yq &> /dev/null; then
          echo "ðŸ“¦ Installing yq (required for reading packages.yml)..."
          sudo pacman -S --needed --noconfirm yq
        fi
      - |
        echo "ðŸ“¦ Installing Arch CLI tools via pacman..."
        PACKAGES=$(yq -r '.arch_pacman_cli_tools | join(" ")' configs/packages.yml)
        sudo pacman -S --needed --noconfirm $PACKAGES
      - |
        echo "ðŸ“¦ Installing Arch AUR tools via yay..."
        if command -v yay &> /dev/null; then
          PACKAGES=$(yq -r '.arch_aur_cli_tools | join(" ")' configs/packages.yml)
          yay -S --needed --noconfirm $PACKAGES
        else
          echo "âš ï¸ yay not installed, skipping AUR tools. Run 'task arch:yay' first."
        fi

  docker:
    desc: Configure Docker service
    cmds:
      - |
        echo "ðŸ³ Configuring Docker service..."
        if command -v docker &> /dev/null; then
          sudo systemctl enable docker 2>/dev/null || true
          sudo systemctl start docker 2>/dev/null || true
          sudo usermod -aG docker $USER 2>/dev/null || true
          echo "âœ“ Docker service configured"
          echo "Note: Log out and back in for Docker group membership to take effect"
        else
          echo "Docker not installed yet. Install via Homebrew: brew install docker"
        fi

  yay:
    desc: Install yay (AUR helper)
    cmds:
      - |
        if ! command -v yay &> /dev/null; then
          echo "Installing yay (AUR helper)..."
          cd /tmp
          git clone https://aur.archlinux.org/yay.git 2>/dev/null || true
          cd yay
          makepkg -si --noconfirm
          cd ~
          echo "âœ“ yay installed"
        else
          echo "âœ“ yay already installed"
        fi

  gui:
    desc: Install GUI applications via pacman and AUR
    cmds:
      - |
        echo "ðŸ“¦ Installing GUI applications via pacman..."
        PACKAGES=$(yq -r '.gui_arch_pacman | join(" ")' configs/packages.yml)
        sudo pacman -S --needed --noconfirm $PACKAGES 2>/dev/null || true
      - |
        echo "ðŸ“¦ Installing GUI applications via AUR..."
        if command -v yay &> /dev/null; then
          PACKAGES=$(yq -r '.gui_arch_aur | join(" ")' configs/packages.yml)
          yay -S --needed --noconfirm $PACKAGES 2>/dev/null || true
        else
          echo "yay not installed. Run 'task arch:yay' first"
        fi

  hyprland:
    desc: Install Hyprland window manager dependencies
    cmds:
      - |
        printf "ðŸªŸ Are you using Hyprland? (y/n) "
        read -r REPLY
        if [ "$REPLY" = "y" ] || [ "$REPLY" = "Y" ]; then
          echo "ðŸ“¦ Installing Hyprland dependencies via pacman..."
          PACKAGES=$(yq -r '.arch_pacman_hyprland_dependencies | join(" ")' configs/packages.yml)
          sudo pacman -S --needed --noconfirm $PACKAGES

          if command -v yay &> /dev/null; then
            echo "ðŸ“¦ Installing Hyprland AUR dependencies..."
            PACKAGES=$(yq -r '.arch_aur_hyprland_dependencies | join(" ")' configs/packages.yml)
            yay -S --needed --noconfirm $PACKAGES
          fi
          echo "âœ“ Hyprland dependencies installed"
        else
          echo "â­ï¸ Skipping Hyprland dependencies"
        fi

  z13:
    desc: Install Asus ROG Flow Z13 specific tools
    cmds:
      - |
        PRODUCT_NAME=$(cat /sys/class/dmi/id/product_name 2>/dev/null || echo "")
        if [[ "$PRODUCT_NAME" == *"Flow Z13"* ]] || [[ "$PRODUCT_NAME" == *"GZ301"* ]]; then
          echo "ðŸŽ® Detected Asus ROG Flow Z13"
          echo "ðŸ“¦ Installing Z13-specific tools..."
          PACKAGES=$(yq -r '.arch_z13_pacman_cli_tools | join(" ")' configs/packages.yml)
          sudo pacman -S --needed --noconfirm $PACKAGES
          echo "âœ“ Z13 tools installed"
        else
          echo "â­ï¸ Not a Z13 device, skipping (detected: $PRODUCT_NAME)"
        fi

  update:
    desc: Update all packages (pacman + AUR + optional Homebrew)
    cmds:
      - |
        echo "Updating Arch packages (pacman)..."
        sudo pacman -Syu --noconfirm
      - |
        if command -v yay &> /dev/null; then
          echo "Updating AUR packages..."
          yay -Syu --noconfirm
        fi
      - |
        if command -v brew &> /dev/null; then
          echo "Updating Homebrew packages..."
          brew update && brew upgrade && brew cleanup
        fi

  clean:
    desc: Clean package caches
    cmds:
      - |
        echo "Cleaning pacman cache..."
        sudo pacman -Sc --noconfirm
      - |
        if command -v yay &> /dev/null; then
          echo "Cleaning AUR cache..."
          yay -Sc --noconfirm
        fi
      - |
        if command -v brew &> /dev/null; then
          echo "Cleaning Homebrew cache..."
          brew cleanup -s
          rm -rf $(brew --cache)
        fi
